name: LTeX Grammar Check (Advanced)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  ltex-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Download and setup ltex-ls
      run: |
        wget https://github.com/valentjn/ltex-ls/releases/download/16.0.0/ltex-ls-16.0.0-linux-x64.tar.gz
        tar -xzf ltex-ls-16.0.0-linux-x64.tar.gz
        echo "$PWD/ltex-ls-16.0.0/bin" >> $GITHUB_PATH
        
    - name: Verify ltex-ls installation
      run: ltex-ls --version
      
    - name: Update LTeX dictionary
      run: python ./ltex_dict_update.py
      
    - name: Find and check all main.tex files
      run: |
        overall_exit_code=0
        
        # æŸ¥æ‰¾æ‰€æœ‰ main.tex æ–‡ä»¶
        tex_files=$(find . -name "main.tex" -type f)
        
        if [ -z "$tex_files" ]; then
          echo "âŒ No main.tex files found!"
          exit 1
        fi
        
        echo "Found the following main.tex files:"
        echo "$tex_files"
        echo ""
        
        # å¯¹æ¯ä¸ªæ–‡ä»¶æ‰§è¡Œæ£€æŸ¥
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            echo "=========================================="
            echo "ğŸ” Checking: $file"
            echo "=========================================="
            
            # ä½¿ç”¨ ltex-ls çš„ CLI æ¨¡å¼æ£€æŸ¥æ–‡ä»¶
            if java -jar "$PWD/ltex-ls-16.0.0/lib/ltex-ls-16.0.0.jar" --client-configuration ltex_setting.json --check "$file"; then
              echo "âœ… $file passed LTeX check"
            else
              echo "âŒ $file failed LTeX check"
              overall_exit_code=1
            fi
            echo ""
          fi
        done <<< "$tex_files"
        
        # å¦‚æœæœ‰ä»»ä½•æ–‡ä»¶å¤±è´¥ï¼Œè®©æ•´ä¸ª job å¤±è´¥
        if [ $overall_exit_code -ne 0 ]; then
          echo "ğŸ’¥ One or more files failed LTeX check"
          exit 1
        else
          echo "ğŸ‰ All files passed LTeX check"
        fi
    - name: Upload LTeX reports (if any)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ltex-reports
        path: |
          **/*.ltex-report.json
          **/*.ltex-report.txt
        if-no-files-found: ignore
