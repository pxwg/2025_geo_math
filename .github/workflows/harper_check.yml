name: Harper Grammar Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  harper-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download and extract Harper CLI
      run: |
        curl -L https://github.com/Automattic/harper/releases/download/v0.50.0/harper-cli-aarch64-unknown-linux-gnu.tar.gz -o harper-cli.tar.gz
        mkdir -p harper-cli
        tar -xzf harper-cli.tar.gz -C harper-cli
        chmod +x harper-cli/harper-cli
        echo "export PATH=\"$PWD/harper-cli:\$PATH\"" >> $GITHUB_ENV
      
    - name: Find and check all .typ files
      run: |
        overall_exit_code=0
        
        # æŸ¥æ‰¾æ‰€æœ‰ .typ æ–‡ä»¶
        typ_files=$(find . -name "*.typ" -type f)
        
        if [ -z "$typ_files" ]; then
          echo "âŒ No .typ files found!"
          exit 1
        fi
        
        echo "Found the following .typ files:"
        echo "$typ_files"
        echo ""
        
        # å¯¹æ¯ä¸ªæ–‡ä»¶æ‰§è¡Œæ£€æŸ¥
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            echo "=========================================="
            echo "ğŸ” Checking: $file"
            echo "=========================================="
            
            if harper-cli lint -o SpellCheck,AnA,SentenceCapitalization,UnclosedQuotes,WrongQuotes,RepeatedWords,Spaces -f ./.harper_dict/ "$file"; then
              echo "âœ… $file passed Harper check"
            else
              echo "âŒ $file failed Harper check"
              overall_exit_code=1
            fi
            echo ""
          fi
        done <<< "$typ_files"
        
        # å¦‚æœæœ‰ä»»ä½•æ–‡ä»¶å¤±è´¥ï¼Œè®©æ•´ä¸ª job å¤±è´¥
        if [ $overall_exit_code -ne 0 ]; then
          echo "ğŸ’¥ One or more files failed Harper check"
          exit 1
        else
          echo "ğŸ‰ All files passed Harper check"
        fi
